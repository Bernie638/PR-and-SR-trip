<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reactor Protection System — Bistable Logic — Divisions A &amp; B</title>
  <style>
    *, *::before, *::after { box-sizing: border-box; }
    html, body {
      margin: 0; padding: 0;
      width: 100%; height: 100%;
      overflow: hidden;             /* pin to viewport — no scroll bars */
      background: #0f0f1a;
      font-family: 'Courier New', Courier, monospace;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    header {
      padding: 10px 24px;
      border-bottom: 1px solid #1e1e38;
      flex-shrink: 0;
    }
    header h1 {
      color: #aabbdd;
      font-size: 0.92rem;
      font-weight: normal;
      letter-spacing: 0.22em;
      text-transform: uppercase;
    }
    /* ── Phase 2: page layout ────────────────────────────────── */
    #main {
      flex: 1;
      display: flex;
      flex-direction: row;
      align-items: stretch;
      min-height: 0;
    }
    #wrap {
      flex: 1;
      min-width: 0;
      min-height: 0;
      padding: 8px 6px;
      display: flex;
      align-items: stretch;
      overflow: hidden;
    }
    #wrap svg {
      width: 100%;
      height: 100%;
      display: block;
    }

    /* ── Power panel ─────────────────────────────────────────── */
    #power-panel {
      width: 186px;
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      padding: 14px 0 14px 12px;
      border-right: 1px solid #1e1e38;
      background: #0b0b18;
      user-select: none;
    }
    #pp-title {
      font-size: 0.75rem;
      letter-spacing: 0.22em;
      color: #aabbdd;
      text-align: center;
      text-transform: uppercase;
      line-height: 1.8;
      margin-bottom: 4px;
    }
    #pp-note {
      font-size: 0.6rem;
      color: #667799;
      text-align: center;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      line-height: 1.5;
      padding-top: 10px;
      border-top: 1px solid #1a1a30;
      margin-top: 10px;
    }

    /* Single positioning context for all bar elements */
    #pp-bar-area {
      flex: 1;
      position: relative;
      min-height: 260px;
    }

    /* ── Zone colour bands (left 42px, bottom = 0 % power) ──── */
    .ppz {
      position: absolute;
      left: 0;
      width: 42px;
      pointer-events: none;
    }
    #ppz-low  { bottom:  0%; height: 15%; background: #0c1e36; border-left: 3px solid #1a4888; }
    #ppz-perm { bottom: 15%; height: 10%; background: #0b2618; border-left: 3px solid #14883c; }
    #ppz-sr   { bottom: 25%; height: 25%; background: #2e1e00; border-left: 3px solid #7a5000; }
    #ppz-pr   { bottom: 50%; height: 50%; background: #2e0900; border-left: 3px solid #7a1800; }

    /* Active fill — semi-transparent white from 0 % to current */
    #pp-fill {
      position: absolute;
      left: 0; width: 42px;
      bottom: 0; height: 0;
      background: rgba(255,255,255,0.13);
      pointer-events: none;
    }

    /* Clickable drag target (covers the bar column) */
    #pp-bar-click {
      position: absolute;
      left: 0; width: 42px;
      top: 0; bottom: 0;
      cursor: ns-resize;
      z-index: 2;
    }

    /* Draggable handle — horizontal bar at current power level */
    #pp-handle {
      position: absolute;
      left: -3px; width: 48px;
      height: 4px;
      bottom: 0;
      transform: translateY(50%);
      background: #fff;
      border-radius: 1px;
      cursor: ns-resize;
      z-index: 4;
      outline: none;
    }
    #pp-handle:focus { background: #88ccff; box-shadow: 0 0 0 3px #88ccff33; }
    /* Arrow pointer to the right of the handle */
    #pp-handle::after {
      content: '';
      position: absolute;
      left: 100%; top: 50%;
      transform: translateY(-50%);
      border: 5px solid transparent;
      border-left: 8px solid #fff;
      margin-left: 1px;
    }
    #pp-handle:focus::after { border-left-color: #88ccff; }

    /* Threshold lines — full panel width, dashed */
    .ppt {
      position: absolute;
      left: 0; right: 12px;
      height: 0;
      pointer-events: none;
      z-index: 3;
    }
    #ppt-pr      { bottom: 50%; border-top: 1px dashed #cc3311bb; }
    #ppt-sr-trip { bottom: 25%; border-top: 1px dashed #bb7700bb; }
    #ppt-sr-perm { bottom: 15%; border-top: 1px dashed #119944bb; }

    /* Threshold labels just above each line */
    .ppt-label {
      position: absolute;
      left: 48px;
      bottom: 3px;
      font-size: 0.7rem;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      white-space: nowrap;
    }
    #ppt-pr      .ppt-label { color: #cc5533; }
    #ppt-sr-trip .ppt-label { color: #cc8800; }
    #ppt-sr-perm .ppt-label { color: #22bb55; }

    /* Zone description labels (centred in each zone, right of bar) */
    .ppzl {
      position: absolute;
      left: 50px; right: 8px;
      font-size: 0.66rem;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      line-height: 1.45;
      display: flex;
      align-items: center;
      pointer-events: none;
    }
    #ppzl-pr   { bottom: 50%; top: 0;       color: #dd6644; }
    #ppzl-sr   { bottom: 25%; height: 25%;  color: #ddaa00; }
    #ppzl-perm { bottom: 15%; height: 10%;  color: #33cc66; }
    #ppzl-low  { bottom:  0%; height: 15%;  color: #55aadd; }

    /* ── Phase 3: "Energized" — signal always present (measurement wire,
       NOT gate output). Medium-bright divisional colour.
       cls-7 stays fill:none; cls-1/cls-4 rect fills not touched here
       because energized elements are wires only (cls-2/cls-3 stroke,
       cls-9/cls-10 arrowhead fill).                                     */
    #wrap svg .energized .cls-2  { stroke: #a05825 !important; }
    #wrap svg .energized .cls-10 { fill:   #a05825 !important; }
    #wrap svg .energized .cls-3  { stroke: #009948 !important; }
    #wrap svg .energized .cls-9  { fill:   #009948 !important; }
    /* Component box shapes (gates, NOT box) when energized */
    #wrap svg .energized .cls-1  { fill: #160a00 !important; stroke: #a05825 !important; }
    #wrap svg .energized .cls-4  { fill: #001408 !important; stroke: #009948 !important; }
    #wrap svg [id^="pr-a"].energized,
    #wrap svg [id^="sr-a"].energized { filter: drop-shadow(0 0 4px #a0582555); }
    #wrap svg [id^="pr-b"].energized,
    #wrap svg [id^="sr-b"].energized { filter: drop-shadow(0 0 4px #00994855); }

    /* ── Phase 5: "Perm-On" — permissive arrow active (power above threshold).
       Thicker stroke + full-bright divisional colour + strong glow so the
       state change is impossible to miss.                                   */
    #wrap svg .perm-on .cls-2  { stroke: #d07832 !important; stroke-width: 5px !important; }
    #wrap svg .perm-on .cls-10 { fill:   #d07832 !important; }
    #wrap svg .perm-on .cls-3  { stroke: #00cc60 !important; stroke-width: 5px !important; }
    #wrap svg .perm-on .cls-9  { fill:   #00cc60 !important; }
    #wrap svg [id^="sr-a"].perm-on { filter: drop-shadow(0 0 10px #d07832cc); }
    #wrap svg [id^="sr-b"].perm-on { filter: drop-shadow(0 0 10px #00cc60cc); }

    /* ── Phase 3: "Tripped" — bistable exceeded setpoint.
       Full-bright divisional colour. Defined AFTER .energized so the
       tripped rules win on elements that carry both classes.
       cls-7 stays fill:none everywhere.                                  */
    /* Division A — warm bronze */
    #wrap svg .tripped .cls-1  { fill: #160a00 !important; stroke: #d07832 !important; }
    #wrap svg .tripped .cls-2  { stroke: #d07832 !important; }
    #wrap svg .tripped .cls-10 { fill:   #d07832 !important; }
    /* Division B — vivid green */
    #wrap svg .tripped .cls-3  { stroke: #00cc60 !important; }
    #wrap svg .tripped .cls-4  { fill: #001408 !important; stroke: #00cc60 !important; }
    #wrap svg .tripped .cls-9  { fill:   #00cc60 !important; }
    /* Division C — bright blue */
    #wrap svg .tripped .cls-6  { stroke: #5599ff !important; }
    #wrap svg .tripped .cls-8  { fill:   #5599ff !important; }
    /* Division D — bright yellow */
    #wrap svg .tripped .cls-5  { stroke: #ffff55 !important; }
    #wrap svg .tripped .cls-11 { fill:   #ffff55 !important; }
    /* Per-division glow — keyed to element ID prefix.
       Defined after .energized glow rules so tripped glow wins. */
    #wrap svg [id^="pr-a"].tripped,
    #wrap svg [id^="sr-a"].tripped { filter: drop-shadow(0 0 7px #d07832cc); }
    #wrap svg [id^="pr-b"].tripped,
    #wrap svg [id^="sr-b"].tripped { filter: drop-shadow(0 0 7px #00cc60cc); }
    #wrap svg [id^="pr-c"].tripped,
    #wrap svg [id^="sr-c"].tripped { filter: drop-shadow(0 0 7px #5599ffcc); }
    #wrap svg [id^="pr-d"].tripped,
    #wrap svg [id^="sr-d"].tripped { filter: drop-shadow(0 0 7px #ffff55cc); }

    /* ── Phase 4: Scram state — voter fired, breakers open ──────────
       Defined LAST so scram overrides tripped on overlapping elements.
       Covers voter boxes (cls-1/cls-4) and output arrows (cls-2/cls-3,
       cls-9/cls-10).                                                   */
    #wrap svg .scram .cls-1  { fill: #1e0000 !important; stroke: #ff2222 !important; }
    #wrap svg .scram .cls-4  { fill: #1e0000 !important; stroke: #ff2222 !important; }
    #wrap svg .scram .cls-2  { stroke: #ff2222 !important; }
    #wrap svg .scram .cls-3  { stroke: #ff2222 !important; }
    #wrap svg .scram .cls-9  { fill:   #ff2222 !important; }
    #wrap svg .scram .cls-10 { fill:   #ff2222 !important; }
    #wrap svg .scram { filter: drop-shadow(0 0 14px #ff2222bb); }

    /* Trip-count text inside each voter box */
    .voter-count {
      font-family: 'Courier New', Courier, monospace;
      pointer-events: none;
      fill: #5566aa;
    }
    .voter-count.scram-text { fill: #ff4444; }

    /* ── Phase 4: Voter status display ──────────────────────────── */
    #pp-scram {
      margin-top: 10px;
      border-top: 1px solid #1a1a30;
      padding-top: 8px;
    }
    .pp-scram-row {
      display: flex;
      align-items: center;
      gap: 4px;
      margin-bottom: 5px;
    }
    .pp-scram-fn {
      font-size: 0.68rem;
      color: #8899cc;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      min-width: 16px;
    }
    .pp-scram-count {
      font-size: 0.75rem;
      color: #8899cc;
      letter-spacing: 0.08em;
      flex: 1;
      text-align: center;
      transition: color 0.2s;
    }
    .pp-scram-count.active { color: #ff4444; }
    .pp-scram-badge {
      font-size: 0.62rem;
      letter-spacing: 0.2em;
      color: #441111;
      border: 1px solid #441111;
      padding: 1px 3px;
      border-radius: 2px;
      text-transform: uppercase;
      transition: color 0.15s, border-color 0.15s, background 0.15s;
    }
    .pp-scram-badge.active {
      color: #ff2222;
      border-color: #ff2222;
      background: #200000;
    }

    /* ── Phase 3: Manual trip buttons ───────────────────────────────── */
    #pp-trips {
      margin-top: 10px;
      border-top: 1px solid #1a1a30;
      padding-top: 8px;
    }
    .pp-trip-sys { margin-bottom: 6px; }
    .pp-trip-lbl {
      font-size: 0.68rem;
      letter-spacing: 0.18em;
      color: #aabbdd;
      text-transform: uppercase;
      margin-bottom: 4px;
      text-align: center;
    }
    .pp-trip-row {
      display: flex;
      gap: 3px;
      justify-content: center;
    }
    .pp-trip-btn {
      flex: 1;
      padding: 4px 0;
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.72rem;
      font-weight: bold;
      letter-spacing: 0.08em;
      background: #0f0f20;
      color: #8899cc;
      border: 1px solid #3a3a60;
      border-radius: 2px;
      cursor: pointer;
      user-select: none;
      transition: background 0.12s, color 0.12s, border-color 0.12s;
    }
    .pp-trip-btn:hover {
      background: #1a1a35;
      border-color: #6677bb;
      color: #aabbdd;
    }
    .pp-trip-btn.active {
      background: #2e1800;
      border-color: #ff9900;
      color: #ff9900;
    }

    /* ── Phase 5: SR Block buttons ──────────────────────────────────── */
    #pp-sblk {
      margin-top: 8px;
      border-top: 1px solid #1a1a30;
      padding-top: 8px;
    }
    .pp-blk-btn {
      flex: 1;
      padding: 4px 0;
      font-family: 'Courier New', Courier, monospace;
      font-size: 0.72rem;
      font-weight: bold;
      letter-spacing: 0.08em;
      background: #0f0f20;
      color: #557755;
      border: 1px solid #2a4a2a;
      border-radius: 2px;
      cursor: pointer;
      user-select: none;
      transition: background 0.12s, color 0.12s, border-color 0.12s;
    }
    .pp-blk-btn:hover { background: #0f1a0f; border-color: #3a663a; color: #77aa77; }
    /* permissive active — button available to press */
    .pp-blk-btn.perm-ready { border-color: #2a6a2a; color: #66bb66; }
    /* block latched — division is blocked */
    .pp-blk-btn.active { background: #001800; border-color: #00cc60; color: #00cc60; }
    /* SVG diagram button hit area — pointer cursor when hovering */
    .sr-btn-hit { cursor: pointer; }

    /* ── SVG dark-theme overrides ────────────────────────────────────── */
    /* cls-7 is used for both component fills (NI circles, bistable boxes)
       AND for L-shaped masking polylines. Those masking polylines are OPEN
       paths; SVG implicitly closes them for fill, creating large filled
       triangles that would hide other elements. Setting fill:none avoids
       this completely — components show their coloured strokes, and wire
       crossovers overlap naturally (fine on a dark background).           */
    #wrap svg .cls-7 { fill: none !important; }

    /* Component shapes: brown-div-A and green-div-B keep coloured strokes
       but get dark fills instead of white.                                */
    #wrap svg .cls-1 { fill: #141428 !important; }   /* div-A rect fills  */
    #wrap svg .cls-4 { fill: #141428 !important; }   /* div-B rect fills  */

    /* ── Injected label styles ──────────────────────────────────────── */
    .diag-lbl {
      font-family: 'Courier New', Courier, monospace;
      pointer-events: none;
      user-select: none;
    }
    /* Division A — brown */
    .diag-lbl.a  { fill: #c8783a; }
    /* Division B — green */
    .diag-lbl.b  { fill: #22cc66; }
  </style>
</head>
<body>

<header>
  <h1>Reactor Protection System &mdash; Bistable Logic &mdash; Divisions A &amp; B</h1>
</header>

<div id="main">

<!-- ══ POWER INDICATOR PANEL ══════════════════════════════════════ -->
<div id="power-panel">
  <div id="pp-title">Reactor<br>Power</div>

  <div id="pp-bar-area">
    <!-- Zone colour bands -->
    <div class="ppz" id="ppz-low"></div>
    <div class="ppz" id="ppz-perm"></div>
    <div class="ppz" id="ppz-sr"></div>
    <div class="ppz" id="ppz-pr"></div>

    <!-- Active fill overlay -->
    <div id="pp-fill"></div>

    <!-- Click / drag target -->
    <div id="pp-bar-click"></div>

    <!-- Draggable handle -->
    <div id="pp-handle"
         role="slider" tabindex="0"
         aria-label="Reactor power level"
         aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"></div>

    <!-- Threshold lines + labels -->
    <div class="ppt" id="ppt-pr">
      <span class="ppt-label">PR Trip</span>
    </div>
    <div class="ppt" id="ppt-sr-trip">
      <span class="ppt-label">SR Trip</span>
    </div>
    <div class="ppt" id="ppt-sr-perm">
      <span class="ppt-label">SR Permissive</span>
    </div>

    <!-- Zone description labels -->
    <div class="ppzl" id="ppzl-pr">Above<br>PR Trip</div>
    <div class="ppzl" id="ppzl-sr">SR Trip<br>Zone</div>
    <div class="ppzl" id="ppzl-perm">Perm.<br>Active</div>
    <div class="ppzl" id="ppzl-low">Low<br>Power</div>
  </div>

  <!-- Phase 5: SR Block buttons -->
  <div id="pp-sblk">
    <div class="pp-trip-lbl">SR Block</div>
    <div class="pp-trip-row">
      <button class="pp-blk-btn" data-div="A">A</button>
      <button class="pp-blk-btn" data-div="B">B</button>
      <button class="pp-blk-btn" data-div="C">C</button>
      <button class="pp-blk-btn" data-div="D">D</button>
    </div>
  </div>

  <!-- Phase 4: Voter status -->
  <div id="pp-scram">
    <div class="pp-scram-row">
      <span class="pp-scram-fn">PR</span>
      <span class="pp-scram-count" id="pps-pr-count">0 / 4</span>
      <span class="pp-scram-badge" id="pps-pr-badge">SCRAM</span>
    </div>
    <div class="pp-scram-row">
      <span class="pp-scram-fn">SR</span>
      <span class="pp-scram-count" id="pps-sr-count">0 / 4</span>
      <span class="pp-scram-badge" id="pps-sr-badge">SCRAM</span>
    </div>
  </div>

  <!-- Phase 3: Manual trip buttons -->
  <div id="pp-trips">
    <div class="pp-trip-sys">
      <div class="pp-trip-lbl">PR Manual Trip</div>
      <div class="pp-trip-row">
        <button class="pp-trip-btn" data-sys="pr" data-div="A">A</button>
        <button class="pp-trip-btn" data-sys="pr" data-div="B">B</button>
        <button class="pp-trip-btn" data-sys="pr" data-div="C">C</button>
        <button class="pp-trip-btn" data-sys="pr" data-div="D">D</button>
      </div>
    </div>
    <div class="pp-trip-sys">
      <div class="pp-trip-lbl">SR Manual Trip</div>
      <div class="pp-trip-row">
        <button class="pp-trip-btn" data-sys="sr" data-div="A">A</button>
        <button class="pp-trip-btn" data-sys="sr" data-div="B">B</button>
        <button class="pp-trip-btn" data-sys="sr" data-div="C">C</button>
        <button class="pp-trip-btn" data-sys="sr" data-div="D">D</button>
      </div>
    </div>
  </div>

  <div id="pp-note">Regions schematic<br>Not actual setpoints</div>
</div><!-- end #power-panel -->

<div id="wrap">
<svg xmlns="http://www.w3.org/2000/svg" viewBox="-90 0 1696.42 807.85">
  <defs>
    <style>
      .cls-1, .cls-2 {
        stroke: #603813;
      }

      .cls-1, .cls-2, .cls-3, .cls-4, .cls-5, .cls-6 {
        stroke-miterlimit: 10;
        stroke-width: 3px;
      }

      .cls-1, .cls-7, .cls-4 {
        fill: #fff;
      }

      .cls-2, .cls-3, .cls-5, .cls-6 {
        fill: none;
      }

      .cls-3, .cls-4 {
        stroke: #006837;
      }

      .cls-8 {
        fill: blue;
      }

      .cls-9 {
        fill: #006837;
      }

      .cls-10 {
        fill: #603813;
      }

      .cls-5 {
        stroke: #fcee21;
      }

      .cls-11 {
        fill: #fcee21;
      }

      .cls-6 {
        stroke: blue;
      }
    </style>
  </defs>
  <g id="pr-d">
    <g id="pr-d-to-pr-a-voter">
      <g>
        <polyline class="cls-5" points="225.56 578.72 122.43 578.72 122.43 595.35"/>
        <path class="cls-11" d="M122.43,604.4c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="pr-d-to-pr-b-voter">
      <g>
        <polyline class="cls-5" points="658.71 575.88 555.58 575.88 555.58 592.51"/>
        <path class="cls-11" d="M555.58,601.56c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
  </g>
  <g id="pr-c">
    <g id="pr-c-to-pr-a-voter">
      <g>
        <polyline class="cls-6" points="203.83 558.67 100.7 558.67 100.7 599.4"/>
        <path class="cls-8" d="M100.7,608.45c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="pr-c-to-pr-b-voter">
      <g>
        <polyline class="cls-6" points="624.66 550.99 521.53 550.99 521.53 591.71"/>
        <path class="cls-8" d="M521.53,600.77c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
  </g>
  <g id="pr-b">
    <g id="pr-b-voter-out-to-scram-bkr">
      <g>
        <line class="cls-3" x1="506.15" y1="652.69" x2="506.15" y2="714.59"/>
        <path class="cls-9" d="M506.15,732.69c-3.16-8.52-8.55-19.09-14.27-25.64l14.27,5.16,14.26-5.16c-5.71,6.55-11.11,17.12-14.26,25.64Z"/>
      </g>
    </g>
    <g id="pr-b-voter">
      <rect class="cls-4" x="482.08" y="606.47" width="48.13" height="46.22"/>
      <polyline class="cls-4" points="438.33 606.47 490.39 606.47 577.47 606.47"/>
    </g>
    <g id="pr-b-output-to-voters">
      <g id="pr-b-output-to-own-voter">
        <g>
          <line class="cls-3" x1="487.83" y1="398.96" x2="487.83" y2="595.49"/>
          <path class="cls-9" d="M487.83,604.55c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
        </g>
      </g>
      <g>
        <line class="cls-3" x1="487.83" y1="469.58" x2="561.81" y2="469.58"/>
        <path class="cls-9" d="M570.86,469.58c-4.26,1.58-9.54,4.28-12.82,7.13l2.58-7.13-2.58-7.13c3.28,2.86,8.56,5.55,12.82,7.13Z"/>
      </g>
      <g>
        <line class="cls-3" x1="488.55" y1="495.06" x2="562.53" y2="495.06"/>
        <path class="cls-9" d="M571.59,495.06c-4.26,1.58-9.54,4.28-12.82,7.13l2.58-7.13-2.58-7.13c3.28,2.86,8.56,5.55,12.82,7.13Z"/>
      </g>
      <g>
        <polyline class="cls-7" points="489.02 542.81 60.44 542.81 60.44 601.56"/>
        <g>
          <polyline class="cls-3" points="489.02 542.81 60.44 542.81 60.44 592.51"/>
          <path class="cls-9" d="M60.44,601.56c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
        </g>
      </g>
    </g>
    <g id="pr-b-bs">
      <g>
        <rect class="cls-7" x="461.99" y="358.54" width="51.66" height="37"/>
        <path class="cls-9" d="M512.16,360.04v34h-48.66v-34h48.66M515.16,357.04h-54.66v40h54.66v-40h0Z"/>
      </g>
      <polyline class="cls-4" points="467.75 386.52 488.49 386.52 488.49 367.56 507.9 367.56"/>
    </g>
    <g id="pr-b-ni-to-bs">
      <g>
        <line class="cls-3" x1="487.83" y1="276.4" x2="487.83" y2="346.06"/>
        <path class="cls-9" d="M487.83,355.12c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="pr-b-ni">
      <path class="cls-7" d="M487.83,274.9c-13.02,0-23.61-10.59-23.61-23.61s10.59-23.61,23.61-23.61,23.61,10.59,23.61,23.61-10.59,23.61-23.61,23.61Z"/>
      <path class="cls-9" d="M487.83,229.18c12.19,0,22.11,9.92,22.11,22.11s-9.92,22.11-22.11,22.11-22.11-9.92-22.11-22.11,9.92-22.11,22.11-22.11M487.83,226.18c-13.87,0-25.11,11.24-25.11,25.11s11.24,25.11,25.11,25.11,25.11-11.24,25.11-25.11-11.24-25.11-25.11-25.11h0Z"/>
    </g>
  </g>
  <g id="pr-a">
    <g id="pr-a-voter-out-to-scram-bkr">
      <g>
        <line class="cls-2" x1="67.82" y1="652.69" x2="67.82" y2="714.59"/>
        <path class="cls-10" d="M67.82,732.69c-3.16-8.52-8.55-19.09-14.27-25.64l14.27,5.16,14.26-5.16c-5.71,6.55-11.11,17.12-14.26,25.64Z"/>
      </g>
    </g>
    <g id="pr-a-voter">
      <rect class="cls-1" x="43.76" y="606.47" width="48.13" height="46.22"/>
      <polyline class="cls-1" points="0 606.47 52.07 606.47 139.15 606.47"/>
    </g>
    <g id="pr-a-output-to-voters">
      <g id="pr-a-output-to-own-voter">
        <g>
          <line class="cls-2" x1="27.33" y1="398.96" x2="27.33" y2="595.49"/>
          <path class="cls-10" d="M27.33,604.55c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
        </g>
      </g>
      <g>
        <line class="cls-2" x1="27.33" y1="469.58" x2="101.32" y2="469.58"/>
        <path class="cls-10" d="M110.37,469.58c-4.26,1.58-9.54,4.28-12.82,7.13l2.58-7.13-2.58-7.13c3.28,2.86,8.56,5.55,12.82,7.13Z"/>
      </g>
      <g>
        <line class="cls-2" x1="28.05" y1="495.06" x2="102.04" y2="495.06"/>
        <path class="cls-10" d="M111.09,495.06c-4.26,1.58-9.54,4.28-12.82,7.13l2.58-7.13-2.58-7.13c3.28,2.86,8.56,5.55,12.82,7.13Z"/>
      </g>
      <g>
        <polyline class="cls-2" points="28.53 525.78 462.72 525.78 462.72 591.89"/>
        <path class="cls-10" d="M462.72,600.94c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="pr-a-bs">
      <g>
        <rect class="cls-7" x="1.5" y="358.54" width="51.66" height="37"/>
        <path class="cls-10" d="M51.66,360.04v34H3v-34h48.66M54.66,357.04H0v40h54.66v-40h0Z"/>
      </g>
      <polyline class="cls-1" points="7.26 386.52 28 386.52 28 367.56 47.41 367.56"/>
    </g>
    <g id="pr-a-ni-to-bs">
      <g>
        <line class="cls-2" x1="27.33" y1="276.4" x2="27.33" y2="346.06"/>
        <path class="cls-10" d="M27.33,355.12c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="pr-a-ni">
      <path class="cls-7" d="M27.33,274.9c-13.02,0-23.61-10.59-23.61-23.61s10.59-23.61,23.61-23.61,23.61,10.59,23.61,23.61-10.59,23.61-23.61,23.61Z"/>
      <path class="cls-10" d="M27.33,229.18c12.19,0,22.11,9.92,22.11,22.11s-9.92,22.11-22.11,22.11-22.11-9.92-22.11-22.11,9.92-22.11,22.11-22.11M27.33,226.18c-13.87,0-25.11,11.24-25.11,25.11s11.24,25.11,25.11,25.11,25.11-11.24,25.11-25.11-11.24-25.11-25.11-25.11h0Z"/>
    </g>
  </g>
  <g id="sr-d">
    <g id="sr-d-to-sr-a-voter">
      <g>
        <polyline class="cls-5" points="1102.56 654.64 999.43 654.64 999.43 671.28"/>
        <path class="cls-11" d="M999.43,680.33c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="sr-d-to-sr-b-voter">
      <g>
        <polyline class="cls-5" points="1552.19 652.55 1449.06 652.55 1449.06 669.18"/>
        <path class="cls-11" d="M1449.06,678.23c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
  </g>
  <g id="sr-c">
    <g id="sr-c-to-sr-a-voter">
      <g>
        <polyline class="cls-6" points="1064.83 629.93 961.7 629.93 961.7 670.65"/>
        <path class="cls-8" d="M961.7,679.7c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="sr-c-to-sr-b-voter">
      <g>
        <polyline class="cls-6" points="1518.41 629.93 1415.29 629.93 1415.29 666.12"/>
        <path class="cls-8" d="M1415.29,675.17c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
  </g>
  <g id="sr-b">
    <g id="sr-b-not-to-and-gate">
      <polyline class="cls-7" points="1479.89 409.19 1479.89 440.43 1407.81 440.43 1407.81 487.66"/>
      <g>
        <polyline class="cls-3" points="1479.89 409.19 1479.89 440.43 1407.81 440.43 1407.81 478.61"/>
        <path class="cls-9" d="M1407.81,487.66c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="sr-b-block-not">
      <rect class="cls-4" x="1459.15" y="377.19" width="41.48" height="32"/>
      <line class="cls-4" x1="1459.15" y1="409.19" x2="1500.63" y2="377.19"/>
      <line class="cls-4" x1="1459.15" y1="377.19" x2="1500.63" y2="409.19"/>
    </g>
    <g id="sr-b-block-output">
      <g id="sr-b-block-to-not">
        <g>
          <line class="cls-3" x1="1478.7" y1="304.59" x2="1478.7" y2="368.14"/>
          <path class="cls-9" d="M1478.7,377.19c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
        </g>
      </g>
      <g id="sr-b-latch">
        <g>
          <polyline class="cls-3" points="1478.7 340.89 1604.92 340.89 1604.92 116.74 1531.44 116.74 1531.31 161.84"/>
          <path class="cls-9" d="M1531.28,170.9c-1.57-4.26-4.25-9.56-7.09-12.84l7.13,2.6,7.14-2.56c-2.87,3.27-5.58,8.54-7.17,12.8Z"/>
        </g>
      </g>
    </g>
    <g id="sr-b-block-and-gate">
      <rect class="cls-4" x="1462.4" y="272" width="32.59" height="32.59"/>
      <polyline class="cls-4" points="1432.77 272 1468.03 272 1527 272"/>
    </g>
    <g id="sr-b-block-permissive">
      <g>
        <line class="cls-3" x1="1443.85" y1="203.26" x2="1443.85" y2="262.95"/>
        <path class="cls-9" d="M1443.85,272c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="sr-b-block-or-gate">
      <g id="sr-b-or-gate-circle">
        <path class="cls-7" d="M1509.78,201.76c-8.42,0-15.27-6.85-15.27-15.27s6.85-15.27,15.27-15.27,15.27,6.85,15.27,15.27-6.85,15.27-15.27,15.27Z"/>
        <path class="cls-9" d="M1509.78,172.72c7.59,0,13.77,6.18,13.77,13.77s-6.18,13.77-13.77,13.77-13.77-6.18-13.77-13.77,6.18-13.77,13.77-13.77M1509.78,169.72c-9.26,0-16.77,7.51-16.77,16.77s7.51,16.77,16.77,16.77,16.77-7.51,16.77-16.77-7.51-16.77-16.77-16.77h0Z"/>
      </g>
      <path class="cls-4" d="M1478.7,170.72l63.11.13-63.11-.13Z"/>
      <g id="sr-b-or-out">
        <g>
          <line class="cls-3" x1="1509.78" y1="203.26" x2="1509.78" y2="262.95"/>
          <path class="cls-9" d="M1509.78,272c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
        </g>
      </g>
    </g>
    <g id="sr-b-momentary-button">
      <polyline class="cls-4" points="1510.26 27.26 1510.26 46.22 1510.26 65.19"/>
      <line class="cls-4" x1="1534.4" y1="46.22" x2="1510.26" y2="46.22"/>
    </g>
    <g id="sr-b-block-button">
      <g id="sr-b-button-to-block">
        <g>
          <line class="cls-3" x1="1488.77" y1="65.19" x2="1488.77" y2="160.67"/>
          <path class="cls-9" d="M1488.77,169.72c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
        </g>
      </g>
      <circle class="cls-4" cx="1488.77" cy="58.96" r="6.22"/>
      <circle class="cls-4" cx="1488.77" cy="33.48" r="6.22"/>
      <line class="cls-4" x1="1488.77" y1="27.26" x2="1488.77"/>
    </g>
    <g id="sr-b-voter-out-to-scram-bkr">
      <g>
        <line class="cls-3" x1="1397.17" y1="725.93" x2="1397.17" y2="796.87"/>
        <path class="cls-9" d="M1397.17,805.93c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="sr-b-voter">
      <rect class="cls-4" x="1373.1" y="679.7" width="48.13" height="46.22"/>
      <polyline class="cls-4" points="1329.35 679.7 1381.42 679.7 1468.5 679.7"/>
    </g>
    <g id="sr-b-output-to-voters">
      <g id="sr-b-output-to-own-voter">
        <g>
          <line class="cls-3" x1="1383.81" y1="520.26" x2="1383.81" y2="670.65"/>
          <path class="cls-9" d="M1383.81,679.7c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
        </g>
      </g>
      <g>
        <line class="cls-3" x1="1383.81" y1="542.81" x2="1457.8" y2="542.81"/>
        <path class="cls-9" d="M1466.85,542.81c-4.26,1.58-9.54,4.28-12.82,7.13l2.58-7.13-2.58-7.13c3.28,2.86,8.56,5.55,12.82,7.13Z"/>
      </g>
      <g>
        <line class="cls-3" x1="1384.53" y1="568.3" x2="1458.52" y2="568.3"/>
        <path class="cls-9" d="M1467.57,568.3c-4.26,1.58-9.54,4.28-12.82,7.13l2.58-7.13-2.58-7.13c3.28,2.86,8.56,5.55,12.82,7.13Z"/>
      </g>
      <g>
        <polyline class="cls-3" points="1383.81 588.72 932.55 591.57 932.55 672.57"/>
        <path class="cls-9" d="M932.55,681.63c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="sr-b-and-gate">
      <rect class="cls-4" x="1366.33" y="487.66" width="32.59" height="32.59"/>
      <polyline class="cls-4" points="1336.7 487.66 1371.96 487.66 1430.92 487.66"/>
    </g>
    <g id="sr-b-bs-to-and-gate">
      <g>
        <line class="cls-3" x1="1356.48" y1="393.19" x2="1356.48" y2="478.61"/>
        <path class="cls-9" d="M1356.48,487.66c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="sr-b-bs">
      <g>
        <rect class="cls-7" x="1330.65" y="354.7" width="51.66" height="37"/>
        <path class="cls-9" d="M1380.81,356.2v34h-48.66v-34h48.66M1383.81,353.2h-54.66v40h54.66v-40h0Z"/>
      </g>
      <polyline class="cls-4" points="1336.4 382.68 1357.15 382.68 1357.15 363.71 1376.55 363.71"/>
    </g>
    <g id="sr-b-ni-to-bs">
      <g>
        <line class="cls-3" x1="1356.48" y1="274.48" x2="1356.48" y2="344.14"/>
        <path class="cls-9" d="M1356.48,353.2c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="sr-b-ni">
      <path class="cls-7" d="M1356.48,272.98c-13.02,0-23.61-10.59-23.61-23.61s10.59-23.61,23.61-23.61,23.61,10.59,23.61,23.61-10.59,23.61-23.61,23.61Z"/>
      <path class="cls-9" d="M1356.48,227.26c12.19,0,22.11,9.92,22.11,22.11s-9.92,22.11-22.11,22.11-22.11-9.92-22.11-22.11,9.92-22.11,22.11-22.11M1356.48,224.26c-13.87,0-25.11,11.24-25.11,25.11s11.24,25.11,25.11,25.11,25.11-11.24,25.11-25.11-11.24-25.11-25.11-25.11h0Z"/>
    </g>
  </g>
  <g id="sr-a">
    <g id="sr-a-not-to-and-gate">
      <polyline class="cls-7" points="1003.89 411.12 1003.89 442.35 931.81 442.35 931.81 489.58"/>
      <g>
        <polyline class="cls-2" points="1003.89 411.12 1003.89 442.35 931.81 442.35 931.81 480.53"/>
        <path class="cls-10" d="M931.81,489.58c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="sr-a-block-not">
      <rect class="cls-1" x="983.14" y="379.12" width="41.48" height="32"/>
      <line class="cls-1" x1="983.14" y1="411.12" x2="1024.63" y2="379.12"/>
      <line class="cls-1" x1="983.14" y1="379.12" x2="1024.63" y2="411.12"/>
    </g>
    <g id="sr-a-block-output">
      <g id="sr-a-block-to-not">
        <g>
          <line class="cls-2" x1="1002.7" y1="306.51" x2="1002.7" y2="370.06"/>
          <path class="cls-10" d="M1002.7,379.12c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
        </g>
      </g>
      <g id="sr-a-latch">
        <g>
          <polyline class="cls-2" points="1002.7 342.81 1128.92 342.81 1128.92 118.66 1055.44 118.66 1055.31 162.13"/>
          <path class="cls-10" d="M1055.28,172.82c-1.85-5.03-5.01-11.28-8.37-15.15l8.41,3.07,8.43-3.02c-3.38,3.86-6.58,10.08-8.46,15.1Z"/>
        </g>
      </g>
    </g>
    <g id="sr-a-block-and-gate">
      <rect class="cls-1" x="986.4" y="273.92" width="32.59" height="32.59"/>
      <polyline class="cls-1" points="956.77 273.92 992.03 273.92 1051 273.92"/>
    </g>
    <g id="sr-a-block-permissive">
      <g>
        <line class="cls-2" x1="967.85" y1="205.18" x2="967.85" y2="264.87"/>
        <path class="cls-10" d="M967.85,273.92c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="sr-a-block-or-gate">
      <g id="sr-a-or-gate-circle">
        <path class="cls-7" d="M1033.78,203.68c-8.42,0-15.27-6.85-15.27-15.27s6.85-15.27,15.27-15.27,15.27,6.85,15.27,15.27-6.85,15.27-15.27,15.27Z"/>
        <path class="cls-10" d="M1033.78,174.64c7.59,0,13.77,6.18,13.77,13.77s-6.18,13.77-13.77,13.77-13.77-6.18-13.77-13.77,6.18-13.77,13.77-13.77M1033.78,171.64c-9.26,0-16.77,7.51-16.77,16.77s7.51,16.77,16.77,16.77,16.77-7.51,16.77-16.77-7.51-16.77-16.77-16.77h0Z"/>
      </g>
      <path class="cls-1" d="M1002.7,172.64l63.11.13-63.11-.13Z"/>
      <g id="sr-a-or-out">
        <g>
          <line class="cls-2" x1="1033.78" y1="205.18" x2="1033.78" y2="264.87"/>
          <path class="cls-10" d="M1033.78,273.92c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
        </g>
      </g>
    </g>
    <g id="sr-a-momentary-button">
      <polyline class="cls-1" points="1034.26 29.18 1034.26 48.14 1034.26 67.11"/>
      <line class="cls-1" x1="1058.4" y1="48.14" x2="1034.26" y2="48.14"/>
    </g>
    <g id="sr-a-block-button">
      <g id="sr-a-button-to-block">
        <g>
          <line class="cls-2" x1="1012.77" y1="67.11" x2="1012.77" y2="162.59"/>
          <path class="cls-10" d="M1012.77,171.64c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
        </g>
      </g>
      <circle class="cls-1" cx="1012.77" cy="60.88" r="6.22"/>
      <circle class="cls-1" cx="1012.77" cy="35.4" r="6.22"/>
      <line class="cls-1" x1="1012.77" y1="29.18" x2="1012.77" y2="1.92"/>
    </g>
    <g id="sr-a-voter-out-to-scram-bkr">
      <g>
        <line class="cls-2" x1="948.3" y1="727.85" x2="948.3" y2="789.74"/>
        <path class="cls-10" d="M948.3,807.85c-3.16-8.52-8.55-19.09-14.27-25.64l14.27,5.16,14.26-5.16c-5.71,6.55-11.11,17.12-14.26,25.64Z"/>
      </g>
    </g>
    <g id="sr-a-voter">
      <rect class="cls-1" x="924.24" y="681.63" width="48.13" height="46.22"/>
      <polyline class="cls-1" points="880.48 681.63 932.55 681.63 1019.63 681.63"/>
    </g>
    <g id="sr-a-output-to-voters">
      <g id="sr-a-output-to-own-voter">
        <g>
          <line class="cls-2" x1="907.81" y1="522.18" x2="907.81" y2="670.65"/>
          <path class="cls-10" d="M907.81,679.7c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
        </g>
      </g>
      <g>
        <line class="cls-2" x1="907.81" y1="544.74" x2="981.8" y2="544.74"/>
        <path class="cls-10" d="M990.85,544.74c-4.26,1.58-9.54,4.28-12.82,7.13l2.58-7.13-2.58-7.13c3.28,2.86,8.56,5.55,12.82,7.13Z"/>
      </g>
      <g>
        <line class="cls-2" x1="908.53" y1="570.22" x2="982.52" y2="570.22"/>
        <path class="cls-10" d="M991.57,570.22c-4.26,1.58-9.54,4.28-12.82,7.13l2.58-7.13-2.58-7.13c3.28,2.86,8.56,5.55,12.82,7.13Z"/>
      </g>
      <g>
        <polyline class="cls-7" points="909 600.94 1348.84 600.94 1348.84 666.72"/>
        <g>
          <polyline class="cls-2" points="909 600.94 1348.84 600.94 1348.84 657.67"/>
          <path class="cls-10" d="M1348.84,666.72c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
        </g>
      </g>
    </g>
    <g id="sr-a-and-gate">
      <rect class="cls-1" x="890.33" y="489.58" width="32.59" height="32.59"/>
      <polyline class="cls-1" points="860.7 489.58 895.96 489.58 954.92 489.58"/>
    </g>
    <g id="sr-a-bs-to-and-gate">
      <g>
        <line class="cls-2" x1="880.48" y1="395.12" x2="880.48" y2="480.53"/>
        <path class="cls-10" d="M880.48,489.58c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="sr-a-bs">
      <g>
        <rect class="cls-7" x="854.65" y="356.62" width="51.66" height="37"/>
        <path class="cls-10" d="M904.81,358.12v34h-48.66v-34h48.66M907.81,355.12h-54.66v40h54.66v-40h0Z"/>
      </g>
      <polyline class="cls-1" points="860.4 384.6 881.14 384.6 881.14 365.64 900.55 365.64"/>
    </g>
    <g id="sr-a-ni-to-bs">
      <g>
        <line class="cls-2" x1="880.48" y1="276.4" x2="880.48" y2="346.06"/>
        <path class="cls-10" d="M880.48,355.12c-1.58-4.26-4.28-9.54-7.13-12.82l7.13,2.58,7.13-2.58c-2.86,3.28-5.55,8.56-7.13,12.82Z"/>
      </g>
    </g>
    <g id="sr-a-ni">
      <path class="cls-7" d="M880.48,274.9c-13.02,0-23.61-10.59-23.61-23.61s10.59-23.61,23.61-23.61,23.61,10.59,23.61,23.61-10.59,23.61-23.61,23.61Z"/>
      <path class="cls-10" d="M880.48,229.18c12.19,0,22.11,9.92,22.11,22.11s-9.92,22.11-22.11,22.11-22.11-9.92-22.11-22.11,9.92-22.11,22.11-22.11M880.48,226.18c-13.87,0-25.11,11.24-25.11,25.11s11.24,25.11,25.11,25.11,25.11-11.24,25.11-25.11-11.24-25.11-25.11-25.11h0Z"/>
    </g>
  </g>
</svg>
</div><!-- end #wrap -->

</div><!-- end #main -->

<script>
(function () {
  'use strict';

  var NS  = 'http://www.w3.org/2000/svg';
  var svg = document.querySelector('#wrap svg');

  /* ── helpers ─────────────────────────────────────────────────────── */

  /** Create and append an SVG <text> element. */
  function txt(x, y, content, divClass, anchor, fontSize) {
    var t = document.createElementNS(NS, 'text');
    t.setAttribute('x', x);
    t.setAttribute('y', y);
    t.setAttribute('text-anchor', anchor || 'middle');
    t.setAttribute('dominant-baseline', 'central');
    t.setAttribute('class', 'diag-lbl ' + (divClass || ''));
    if (fontSize) t.setAttribute('font-size', fontSize);
    t.textContent = content;
    svg.appendChild(t);
    return t;
  }

  /**
   * Multi-line label. Lines are stacked; the block is vertically centred
   * around (x, y).  lineH is in SVG user units.
   */
  function multiLine(x, y, lines, divClass, anchor, fontSize, lineH) {
    lineH   = lineH   || 22;
    fontSize = fontSize || 18;
    var total = (lines.length - 1) * lineH;
    var top   = y - total / 2;
    lines.forEach(function (line, i) {
      txt(x, top + i * lineH, line, divClass, anchor, fontSize);
    });
  }

  /**
   * Return the centre {x, y} of an SVG element's bounding box.
   * Returns null if the element is not found.
   */
  function centre(id) {
    var el = svg.getElementById(id);
    if (!el) { console.warn('PMS: element not found –', id); return null; }
    var b = el.getBBox();
    return { x: b.x + b.width / 2, y: b.y + b.height / 2, b: b };
  }

  /* ── run after first layout pass ─────────────────────────────────── */
  requestAnimationFrame(function () {

    /* ══ NUCLEAR INSTRUMENTS ═══════════════════════════════════════════
       All NI labels go ABOVE their circle.

       PR-A sits at the far-left edge (circle cx ≈ 27).  The viewBox has
       been expanded 90 units to the left ("-90 0 1696.42 807.85") so the
       centred label at x=c.x doesn't clip.

       SR labels must clear the Permissive arrow (starts at y ≈ 205) AND
       the OR-gate circle (centre y ≈ 188, top y ≈ 173).  Placing the
       two-line block midpoint at c.y − 130 puts lines at ≈ y 110 and
       y 132, with ~40 units of breathing room above the OR gate.

       PR-B label position was confirmed correct by user — leave as-is.  */

    (function niLabels() {
      var c;

      // PR-A  (viewBox expanded left so centred label fits)
      c = centre('pr-a-ni');
      if (c) multiLine(c.x, c.y - 100, ["'A' Power Range", 'Nuclear Instrument'],
                       'a', 'middle', 18, 22);

      // PR-B  (confirmed perfect – do not touch)
      c = centre('pr-b-ni');
      if (c) multiLine(c.x, c.y - 46, ["'B' Power Range", 'Nuclear Instrument'],
                       'b', 'middle', 18, 22);

      // SR-A  (raised further to clear OR gate and permissive)
      c = centre('sr-a-ni');
      if (c) multiLine(c.x, c.y - 130, ["'A' Source Range", 'Nuclear Instrument'],
                       'a', 'middle', 18, 22);

      // SR-B
      c = centre('sr-b-ni');
      if (c) multiLine(c.x, c.y - 130, ["'B' Source Range", 'Nuclear Instrument'],
                       'b', 'middle', 18, 22);
    }());

    /* ══ GATE LABELS ════════════════════════════════════════════════════
       Centred in each gate's bounding box.                              */

    (function gateLabels() {
      function gLbl(id, label) {
        var c = centre(id);
        if (!c) return;
        var div = id.indexOf('sr-a') === 0 ? 'a' : 'b';
        txt(c.x, c.y, label, div, 'middle', 14);
      }

      // NOT gates (X-boxes: 41.48 × 32 units)
      gLbl('sr-a-block-not', 'NOT');
      gLbl('sr-b-block-not', 'NOT');

      // Trip-path AND gates (32.59 × 32.59 units)
      gLbl('sr-a-and-gate',       'AND');
      gLbl('sr-b-and-gate',       'AND');

      // Block-path AND gates
      gLbl('sr-a-block-and-gate', 'AND');
      gLbl('sr-b-block-and-gate', 'AND');

      // OR gates – bbox is wide (includes input wire), so use computed
      // circle centres instead of getBBox centre.
      // sr-a OR circle centre: (1033.78, 174.64 + 13.77) = (1033.78, 188.41)
      // sr-b OR circle centre: (1509.78, 172.72 + 13.77) = (1509.78, 186.49)
      txt(1033.78, 188.41, 'OR', 'a', 'middle', 12);
      txt(1509.78, 186.49, 'OR', 'b', 'middle', 12);
    }());

    /* ══ VOTER LABELS ("2oo4") ══════════════════════════════════════════
       The voter group bbox includes input side-wires, so the visual
       square centre is used directly from the SVG rect geometry.
         pr-a rect: x=43.76, y=606.47, w=48.13, h=46.22  → cx=67.82, cy=629.58
         pr-b rect: x=482.08, y=606.47               → cx=506.15, cy=629.58
         sr-a rect: x=924.24, y=681.63               → cx=948.30, cy=704.74
         sr-b rect: x=1373.10, y=679.70              → cx=1397.17, cy=702.81  */

    (function voterLabels() {
      [
        { x: 67.82,   y: 629.58, d: 'a' },
        { x: 506.15,  y: 629.58, d: 'b' },
        { x: 948.30,  y: 704.74, d: 'a' },
        { x: 1397.17, y: 702.81, d: 'b' },
      ].forEach(function (v) {
        txt(v.x, v.y, '2oo4', v.d, 'middle', 16);
      });
    }());

    /* ══ "To Scram Breaker" ═════════════════════════════════════════════
       Placed beside the midpoint of each voter-output downward arrow.
       pr arrows run 652.69 → 732.69; sr arrows run to ~806-808.        */

    (function scramLabels() {
      // pr-a / sr-a: label to the right (anchor start)
      // pr-b: label to the right; sr-b: near right SVG edge → to the left
      [
        { x: 67.82,   yMid: (652.69 + 732.69) / 2, d: 'a', side:  1  },
        { x: 506.15,  yMid: (652.69 + 732.69) / 2, d: 'b', side:  1  },
        { x: 948.30,  yMid: (727.85 + 807.85) / 2, d: 'a', side:  1  },
        { x: 1397.17, yMid: (725.93 + 805.93) / 2, d: 'b', side: -1  }, // left
      ].forEach(function (s) {
        var offset = s.side * 12;
        var anchor = s.side > 0 ? 'start' : 'end';
        txt(s.x + offset, s.yMid, 'To Scram Breaker', s.d, anchor, 16);
      });
    }());

    /* ══ PERMISSIVE ══════════════════════════════════════════════════════
       Vertical lines feed into the block-AND gate input.
       Placed to the LEFT of each line (anchor end).
         sr-a: x=967.85, y 205.18→264.87   midY = 235.03
         sr-b: x=1443.85, y 203.26→262.95  midY = 233.11                */

    (function permLabels() {
      // Place just above the arrow start (arrow begins at y≈205/203) so the
      // label sits above the NI circle (top y≈226) and clearly names the arrow.
      // Two lines per division: top shifts up, bottom ("ON") sits right above the arrow.
      // Active state: "PERMISSIVE" / "ON". Inactive: "Permissive" / (empty).
      window._pmsPermLabelA1 = txt(967.85  - 10, 176, 'Permissive', 'a', 'end', 17);
      window._pmsPermLabelA2 = txt(967.85  - 10, 196, '',           'a', 'end', 17);
      window._pmsPermLabelB1 = txt(1443.85 - 10, 176, 'Permissive', 'b', 'end', 17);
      window._pmsPermLabelB2 = txt(1443.85 - 10, 196, '',           'b', 'end', 17);
    }());

    /* ══ BLOCK BUTTONS ════════════════════════════════════════════════════
       The momentary-button symbol has a horizontal arm extending right.
         sr-a: arm ends at x=1058.4, y=48.14  → label starts there + 12
         sr-b: arm ends at x=1534.4, y=46.22  → label starts there + 12  */

    (function buttonLabels() {
      txt(1058.4 + 12, 48.14, 'Block Button', 'a', 'start', 17);
      txt(1534.4 + 12, 46.22, 'Block Button', 'b', 'start', 17);
    }());

    /* ══ LATCH ════════════════════════════════════════════════════════════
       Each latch path forms an inverted U going right then up then left.
         sr-a: rightmost x=1128.92, vertical span y=118.66→342.81  midY=230.74
               label to the RIGHT of the vertical segment (anchor start)
         sr-b: rightmost x=1604.92 (SVG right edge), span y=116.74→340.89
               label to the LEFT (anchor end) to avoid clipping            */

    (function latchLabels() {
      txt(1128.92 + 10, (118.66 + 342.81) / 2, 'Latch', 'a', 'start', 17);
      txt(1604.92 - 10, (116.74 + 340.89) / 2, 'Latch', 'b', 'end',   17);
    }());

  }); // end requestAnimationFrame

}());

/* ══ PHASE 2 — Power Indicator ══════════════════════════════════ */
(function powerIndicator() {
  'use strict';

  var barArea = document.getElementById('pp-bar-area');
  var fill    = document.getElementById('pp-fill');
  var handle  = document.getElementById('pp-handle');
  var clickEl = document.getElementById('pp-bar-click');

  var power    = 0;   // current level 0–100
  var dragging = false;

  /* Update all visual elements to reflect `pct` (0–100). */
  function setPower(pct) {
    power = Math.max(0, Math.min(100, +pct || 0));
    var bot = power.toFixed(3) + '%';
    fill.style.height   = bot;
    handle.style.bottom = bot;
    handle.setAttribute('aria-valuenow', power.toFixed(1));
    /* Block logic must update latch state BEFORE trip logic reads it. */
    if (window._pmsBlockPowerUpdate) window._pmsBlockPowerUpdate(power);
    if (window._pmsUpdateTrips) window._pmsUpdateTrips(power);
  }

  /* Convert a clientY coordinate to a 0–100 power percentage. */
  function pctFromClientY(clientY) {
    var r = barArea.getBoundingClientRect();
    return (1 - (clientY - r.top) / r.height) * 100;
  }

  /* ── Mouse ─────────────────────────────────────────────────── */
  function onMouseDown(e) {
    dragging = true;
    setPower(pctFromClientY(e.clientY));
    e.preventDefault();
  }
  clickEl.addEventListener('mousedown', onMouseDown);
  handle.addEventListener('mousedown',  onMouseDown);

  document.addEventListener('mousemove', function (e) {
    if (dragging) setPower(pctFromClientY(e.clientY));
  });
  document.addEventListener('mouseup', function () { dragging = false; });

  /* ── Touch ─────────────────────────────────────────────────── */
  function onTouchStart(e) {
    dragging = true;
    setPower(pctFromClientY(e.touches[0].clientY));
    e.preventDefault();
  }
  clickEl.addEventListener('touchstart', onTouchStart, { passive: false });
  handle.addEventListener('touchstart',  onTouchStart, { passive: false });

  document.addEventListener('touchmove', function (e) {
    if (dragging) {
      setPower(pctFromClientY(e.touches[0].clientY));
      e.preventDefault();
    }
  }, { passive: false });
  document.addEventListener('touchend', function () { dragging = false; });

  /* ── Keyboard (focus handle, use arrow keys) ───────────────── */
  handle.addEventListener('keydown', function (e) {
    var step = e.shiftKey ? 10 : 1;
    if (e.key === 'ArrowUp'   || e.key === 'ArrowRight') { setPower(power + step); e.preventDefault(); }
    if (e.key === 'ArrowDown' || e.key === 'ArrowLeft')  { setPower(power - step); e.preventDefault(); }
    if (e.key === 'Home')  { setPower(0);   e.preventDefault(); }
    if (e.key === 'End')   { setPower(100); e.preventDefault(); }
  });

  setPower(0);
}());

/* ══ PHASE 3 — Bistable Trip Logic ══════════════════════════════ */
(function tripLogic() {
  'use strict';

  var PR_TRIP = 50;   // power % at which all PR bistables trip
  var SR_TRIP = 25;   // power % at which all SR bistables trip

  /* Per-division manual trip toggles (independent of power level). */
  var manual = {
    prA: false, prB: false, prC: false, prD: false,
    srA: false, srB: false, srC: false, srD: false,
  };

  var _power = 0;
  var svg = document.querySelector('#wrap svg');

  /* ── Always-energized elements ─────────────────────────────────
     ni-to-bs wires carry a measurement signal at all times.
     not-to-and-gate wires are managed by blockLogic (HIGH when
     unblocked, LOW when blocked) and are NOT listed here.         */
  var ALWAYS_ON = [
    'pr-a-ni-to-bs', 'pr-b-ni-to-bs',
    'sr-a-ni-to-bs', 'sr-b-ni-to-bs',
  ];
  ALWAYS_ON.forEach(function (id) {
    var el = svg.getElementById(id);
    if (el) el.classList.add('energized');
  });

  /* ── Signal paths ──────────────────────────────────────────────
     PR: no block logic; full path to voter.
     SR: split at trip AND gate.
       _pre  = NI → bistable → bs-to-and-gate  (lights whenever bistable trips)
       _post = and-gate + output-to-voters      (lights only when NOT blocked)
     C/D: off-diagram voter arrows (suppressed when blocked).          */
  var PATHS = {
    prA: ['pr-a-ni', 'pr-a-ni-to-bs', 'pr-a-bs', 'pr-a-output-to-voters'],
    prB: ['pr-b-ni', 'pr-b-ni-to-bs', 'pr-b-bs', 'pr-b-output-to-voters'],
    prC: ['pr-c-to-pr-a-voter', 'pr-c-to-pr-b-voter'],
    prD: ['pr-d-to-pr-a-voter', 'pr-d-to-pr-b-voter'],
    srA_pre:  ['sr-a-ni', 'sr-a-ni-to-bs', 'sr-a-bs', 'sr-a-bs-to-and-gate'],
    srA_post: ['sr-a-and-gate', 'sr-a-output-to-voters'],
    srB_pre:  ['sr-b-ni', 'sr-b-ni-to-bs', 'sr-b-bs', 'sr-b-bs-to-and-gate'],
    srB_post: ['sr-b-and-gate', 'sr-b-output-to-voters'],
    srC: ['sr-c-to-sr-a-voter', 'sr-c-to-sr-b-voter'],
    srD: ['sr-d-to-sr-a-voter', 'sr-d-to-sr-b-voter'],
  };

  /* Toggle the 'tripped' class on every element in a named path. */
  function setPath(key, state) {
    (PATHS[key] || []).forEach(function (id) {
      var el = svg.getElementById(id);
      if (el) el.classList.toggle('tripped', state);
    });
  }

  /* Recompute every path and button state from current power + manual flags.
     Block state is read via window._pmsIsBlocked (set by blockLogic).      */
  function updateAll() {
    var prPow  = _power >= PR_TRIP;
    var srPow  = _power >= SR_TRIP;
    var isBlk  = window._pmsIsBlocked || function () { return false; };

    /* PR: no block logic */
    setPath('prA', prPow || manual.prA);
    setPath('prB', prPow || manual.prB);
    setPath('prC', prPow || manual.prC);
    setPath('prD', prPow || manual.prD);

    /* SR: bistable state (power or manual), independent of block */
    var srA = srPow || manual.srA;
    var srB = srPow || manual.srB;
    var srC = srPow || manual.srC;
    var srD = srPow || manual.srD;

    /* SR: block state per division.
       C and D are off-diagram — if either A or B has been blocked the
       operator has blocked the SR function, so treat C and D as blocked
       too. Without this they would still send trip signals to the voter
       and satisfy 2oo4 even while A and B are inhibited.              */
    var bA = isBlk('A'), bB = isBlk('B');
    var bC = isBlk('C') || bA || bB;
    var bD = isBlk('D') || bA || bB;

    /* Pre-AND path: shows bistable trip regardless of block */
    setPath('srA_pre',  srA);
    setPath('srB_pre',  srB);

    /* Post-AND path (and-gate + output): only if NOT blocked */
    setPath('srA_post', srA && !bA);
    setPath('srB_post', srB && !bB);

    /* Off-diagram C/D: voter arrows suppressed when blocked */
    setPath('srC', srC && !bC);
    setPath('srD', srD && !bD);

    /* Trip buttons */
    document.querySelectorAll('.pp-trip-btn').forEach(function (btn) {
      var key  = btn.dataset.sys + btn.dataset.div;
      var auto = (btn.dataset.sys === 'pr') ? prPow : srPow;
      btn.classList.toggle('active', manual[key] || auto);
    });

    /* Voting: blocked divisions don't contribute to voter count */
    if (window._pmsVotingUpdate) {
      window._pmsVotingUpdate({
        prA: prPow || manual.prA, prB: prPow || manual.prB,
        prC: prPow || manual.prC, prD: prPow || manual.prD,
        srA: srA && !bA, srB: srB && !bB,
        srC: srC && !bC, srD: srD && !bD,
      });
    }
  }

  /* Bridge: called by the power indicator on every level change. */
  window._pmsUpdateTrips = function (pct) {
    _power = pct;
    updateAll();
  };

  /* Bridge: called by blockLogic when a latch state changes. */
  window._pmsRefreshTrips = updateAll;

  /* Manual trip buttons: toggle on click, then refresh everything. */
  document.querySelectorAll('.pp-trip-btn').forEach(function (btn) {
    btn.addEventListener('click', function () {
      var key = btn.dataset.sys + btn.dataset.div;
      manual[key] = !manual[key];
      updateAll();
    });
  });

  /* Initial state (power = 0, all manual clear). */
  updateAll();
}());

/* ══ PHASE 4 — 2oo4 Voting Logic ════════════════════════════════ */
(function votingLogic() {
  'use strict';

  var NS  = 'http://www.w3.org/2000/svg';
  var svg = document.querySelector('#wrap svg');

  /* ── Voter box centres (from SVG rect geometry) ─────────────────
       pr-a rect: x=43.76 w=48.13 → cx=67.82   y=606.47 h=46.22 → cy=629.58
       pr-b rect: x=482.08 w=48.13 → cx=506.15  same y → cy=629.58
       sr-a rect: x=924.24 w=48.13 → cx=948.30  y=681.63 h=46.22 → cy=704.74
       sr-b rect: x=1373.10 w=48.13 → cx=1397.17 y=679.70 h=46.22 → cy=702.81 */
  var VOTER_CTR = {
    'pr-a': { x: 67.82,   y: 629.58 },
    'pr-b': { x: 506.15,  y: 629.58 },
    'sr-a': { x: 948.30,  y: 704.74 },
    'sr-b': { x: 1397.17, y: 702.81 },
  };

  /* ── SVG elements that turn red when a function scrams ──────────
     Both A and B voter boxes activate because all four division
     scram breakers open when any voter fires.                      */
  var SCRAM_ELS = {
    pr: ['pr-a-voter', 'pr-b-voter',
         'pr-a-voter-out-to-scram-bkr', 'pr-b-voter-out-to-scram-bkr'],
    sr: ['sr-a-voter', 'sr-b-voter',
         'sr-a-voter-out-to-scram-bkr', 'sr-b-voter-out-to-scram-bkr'],
  };

  /* ── Trip-count labels ("N / 4") inside each voter box ──────────
     Created in a RAF so the SVG is fully laid out.
     Positioned at centre_x, centre_y + 13 (below the "2oo4" text). */
  var countEls = {};

  requestAnimationFrame(function () {
    Object.keys(VOTER_CTR).forEach(function (key) {
      var v = VOTER_CTR[key];
      var t = document.createElementNS(NS, 'text');
      t.setAttribute('x', v.x);
      t.setAttribute('y', v.y + 13);
      t.setAttribute('text-anchor', 'middle');
      t.setAttribute('dominant-baseline', 'central');
      t.setAttribute('class', 'voter-count');
      t.setAttribute('font-size', 10);
      t.textContent = '0 / 4';
      svg.appendChild(t);
      countEls[key] = t;
    });
  });

  /* ── Apply or clear scram state for one function ────────────── */
  function setScram(fn, count) {
    var scram = count >= 2;

    /* SVG: voter boxes and scram-breaker arrows */
    SCRAM_ELS[fn].forEach(function (id) {
      var el = svg.getElementById(id);
      if (el) el.classList.toggle('scram', scram);
    });

    /* SVG: count text in both voter boxes for this function */
    ['a', 'b'].forEach(function (d) {
      var el = countEls[fn + '-' + d];
      if (el) {
        el.textContent = count + ' / 4';
        el.classList.toggle('scram-text', scram);
      }
    });

    /* HTML panel: count and SCRAM badge */
    var countEl = document.getElementById('pps-' + fn + '-count');
    var badgeEl = document.getElementById('pps-' + fn + '-badge');
    if (countEl) {
      countEl.textContent = count + ' / 4';
      countEl.classList.toggle('active', scram);
    }
    if (badgeEl) badgeEl.classList.toggle('active', scram);
  }

  /* ── Bridge: called by tripLogic on every state change ─────────
     PR and SR are evaluated on completely separate voter groups —
     PR-A + SR-C cannot combine to satisfy either voter.           */
  window._pmsVotingUpdate = function (state) {
    var prCount = [state.prA, state.prB, state.prC, state.prD]
                    .filter(Boolean).length;
    var srCount = [state.srA, state.srB, state.srC, state.srD]
                    .filter(Boolean).length;
    setScram('pr', prCount);
    setScram('sr', srCount);
  };

  /* Initialise to 0 / 4, no scram. */
  setScram('pr', 0);
  setScram('sr', 0);
}());

/* ══ PHASE 5 — SR Block Logic ═══════════════════════════════════ */
(function blockLogic() {
  'use strict';

  var NS      = 'http://www.w3.org/2000/svg';
  var svg     = document.querySelector('#wrap svg');
  var SR_PERM = 15;   // power % threshold for block permissive
  var _power  = 0;

  /* Latch state — true = that SR division is currently blocked */
  var latched = { A: false, B: false, C: false, D: false };

  /* ── SVG element IDs per on-diagram division ────────────────────
     The block circuit path, traced from top to bottom:
       block-button → button-to-block wire → OR gate horizontal bus
       OR gate circle → OR gate output → block AND gate
       block AND gate → block-output (wire to NOT + latch feedback)
       block-not (NOT gate box) → not-to-and-gate → trip AND gate  */
  var SVGELS = {
    A: {
      permissive:  'sr-a-block-permissive',
      orGate:      'sr-a-block-or-gate',     /* circle + bus + output arrow */
      andGate:     'sr-a-block-and-gate',    /* block AND gate box          */
      blockOutput: 'sr-a-block-output',      /* wire to NOT + latch path    */
      blockNot:    'sr-a-block-not',         /* NOT gate box                */
      notToAnd:    'sr-a-not-to-and-gate',   /* NOT output → trip AND gate  */
      btnEls:      ['sr-a-block-button', 'sr-a-momentary-button'],
    },
    B: {
      permissive:  'sr-b-block-permissive',
      orGate:      'sr-b-block-or-gate',
      andGate:     'sr-b-block-and-gate',
      blockOutput: 'sr-b-block-output',
      blockNot:    'sr-b-block-not',
      notToAnd:    'sr-b-not-to-and-gate',
      btnEls:      ['sr-b-block-button', 'sr-b-momentary-button'],
    },
    /* C and D: off-diagram — no SVG block circuit */
  };

  /* ── Public interface ───────────────────────────────────────── */
  window._pmsIsBlocked = function (div) { return latched[div] || false; };

  /* ── Helpers ─────────────────────────────────────────────────── */
  function perm()        { return _power >= SR_PERM; }
  function tog(id, cls, state) {
    var el = svg.getElementById(id);
    if (el) el.classList.toggle(cls, state);
  }

  /* ── Update SVG visuals for one on-diagram division ─────────── */
  function updateDivVisuals(div) {
    var e = SVGELS[div];
    if (!e) return;
    var p    = perm();
    var lock = latched[div];

    /* Permissive arrow: lit whenever power is above the threshold.
       Use .perm-on (thicker, brighter) rather than .energized so the
       state change is clearly visible. Also swap the label text.       */
    tog(e.permissive, 'perm-on', p);
    var lbl1 = (div === 'A') ? window._pmsPermLabelA1 : window._pmsPermLabelB1;
    var lbl2 = (div === 'A') ? window._pmsPermLabelA2 : window._pmsPermLabelB2;
    if (lbl1) lbl1.textContent = p ? 'PERMISSIVE' : 'Permissive';
    if (lbl2) lbl2.textContent = p ? 'ON' : '';

    /* When block is latched the whole path from OR gate through NOT gate
       carries a HIGH signal — light it up in the divisional colour.     */
    tog(e.orGate,      'energized', lock);
    tog(e.andGate,     'energized', lock);
    tog(e.blockOutput, 'energized', lock);   /* includes latch feedback   */
    tog(e.blockNot,    'energized', lock);   /* NOT gate receiving HIGH   */

    /* NOT gate output wire: HIGH (energized) when unblocked,
       goes dim when block is active — the trip path is inhibited.       */
    tog(e.notToAnd, 'energized', !lock);
  }

  /* ── Update HTML block buttons for all four divisions ────────── */
  function syncHtmlButtons() {
    var p = perm();
    document.querySelectorAll('.pp-blk-btn').forEach(function (btn) {
      var div = btn.dataset.div;
      var lock = latched[div] || false;
      btn.classList.toggle('active',     lock);
      btn.classList.toggle('perm-ready', p && !lock);
    });
  }

  /* ── Press a block button for one division ──────────────────────
     Rules:
       • Below permissive  → no effect (permissive input to AND gate LOW)
       • Above permissive  → latch sets, block becomes active
     A momentary visual pulse is shown on the button and AND gate.      */
  function pressButton(div) {
    if (!perm()) return;

    latched[div] = true;

    /* Brief animation: button + AND gate flash as "tripped" (pulse) */
    var e = SVGELS[div];
    if (e) {
      e.btnEls.forEach(function (id) { tog(id, 'tripped', true); });
      tog(e.andGate, 'tripped', true);
      setTimeout(function () {
        e.btnEls.forEach(function (id) { tog(id, 'tripped', false); });
        tog(e.andGate, 'tripped', false);
        updateDivVisuals(div);    /* refresh steady-state after pulse */
      }, 250);
    }

    updateDivVisuals(div);
    syncHtmlButtons();
    if (window._pmsRefreshTrips) window._pmsRefreshTrips();
  }

  /* ── Power change callback (called by setPower BEFORE tripLogic) */
  window._pmsBlockPowerUpdate = function (pct) {
    _power = pct;

    /* If permissive drops below threshold, release every latch.
       Operator must push the button again once permissive returns. */
    if (!perm()) {
      Object.keys(latched).forEach(function (d) { latched[d] = false; });
    }

    /* Update block circuit visuals for A and B */
    ['A', 'B'].forEach(updateDivVisuals);
    syncHtmlButtons();
    /* tripLogic will be called next by setPower — no explicit call needed */
  };

  /* ── Clickable hit-area rects over the SVG diagram buttons ──────
     Placed in a RAF so they land on top of all existing SVG content.
     sr-a: button circles at x=1012.77, arm at y=48.14, x to 1058.4
     sr-b: button circles at x=1488.77, arm at y=46.22, x to 1534.4  */
  requestAnimationFrame(function () {
    [
      { div: 'A', x: 1002, y: 0, w: 65, h: 78 },
      { div: 'B', x: 1480, y: 0, w: 62, h: 78 },
    ].forEach(function (ha) {
      var r = document.createElementNS(NS, 'rect');
      r.setAttribute('x', ha.x);
      r.setAttribute('y', ha.y);
      r.setAttribute('width',  ha.w);
      r.setAttribute('height', ha.h);
      r.setAttribute('fill',   'transparent');
      r.setAttribute('class',  'sr-btn-hit');
      r.addEventListener('click', function () { pressButton(ha.div); });
      svg.appendChild(r);
    });

    /* Initialise not-to-and-gate as energized (unblocked at startup) */
    ['A', 'B'].forEach(updateDivVisuals);
    syncHtmlButtons();
  });

  /* HTML panel block buttons — same pressButton() as SVG */
  document.querySelectorAll('.pp-blk-btn').forEach(function (btn) {
    btn.addEventListener('click', function () { pressButton(btn.dataset.div); });
  });
}());
</script>

</body>
</html>
